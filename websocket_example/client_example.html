<!DOCTYPE html>
<html lang="en">
<head>
    <title>WebSocket Client</title>
    <style>
        #output {
            border: solid 1px #000;
        }
    </style>
    <script src="jquery-1.8.0.min.js" type="text/javascript"></script>
    <script src="three.min.js"></script>
    <script type="text/javascript">
    var camera, scene, renderer, controls,
    loader, mesh;
    
     $(document).ready(function() {
        try {

            var host = "ws://localhost:9876/";
            var s;
            if ( $.browser.mozilla ) {
                // firefox
                s = new MozWebSocket(host);
            } else {
                // other browsers
               s = new WebSocket(host);
            }

            console.log("Host:", host);


            s.onopen = function (e) {
            console.log("Socket opened.");
            };

            s.onclose = function (e) {
                console.log("Socket closed.");
            };

            s.onmessage = function (e) {
                var msg = JSON.parse(e.data);
                if(msg.rtype == "image")
                {
                    $("#container").hide();
                    $("#image_dest").html("<img src='" + msg.blob + "'/>");
                    $("#image_dest").show();
                }
                else if(msg.rtype == "json")
                {
                    $("#image_dest").hide();
                    for(i=0;i<msg.blob.length;i++)
                        monkeyfi(msg.blob[i])
                    $("#container").show();
                }
                else
                {
                    console.log("Socket message:", e.data);
                    $("#info").html("<p><b>response:</b> " + msg.answer + "</p>")
                }

            };

            s.onerror = function (e) {
                console.log("Socket error:", e);
            };

        } catch (ex) {
            console.log("Socket exception:", ex);
        }

        $("#form").submit(
        function (e) {
            e.preventDefault();
            msg = {"msg": "working", "py": $("#pysource").val() + "\n",
                   "width": 800, "height": 800, "rtype": $("#rtype").val() };
            s.send(JSON.stringify(msg));
        });
        

        init();
        animate();

        function init() {

            var container = document.getElementById( 'container' );

            camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, .1, 10000 );
            camera.position.set( 0, - 6, 60 );

            scene = new THREE.Scene();

            renderer = new THREE.WebGLRenderer();
            renderer.setSize( window.innerWidth, window.innerHeight );

            var light = new THREE.DirectionalLight(0xffffff);
            light.position = camera.position;
            scene.add(light);

            controls = new THREE.TrackballControls(camera, renderer.domElement);
            controls.rotateSpeed = 0.5;
            controls.dynamicDampingFactor = 0.5;

            container.appendChild( renderer.domElement );

            //

            window.addEventListener( 'resize', onWindowResize, false );

        }

        function onWindowResize() {

            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            renderer.setSize( window.innerWidth, window.innerHeight );

            controls.screen.width = window.innerWidth;
            controls.screen.height = window.innerHeight;
            controls.radius = 0.25 * (window.innerWidth + window.innerHeight);
        }

        //

        function animate() {

            requestAnimationFrame( animate );
            controls.update();
            render();

        }

        function render() {
            renderer.render( scene, camera );
        }
        
        function monkeyfi(data)
        {
            loader = new THREE.JSONLoader();
            loader.createModel(data,function ( geometry ) {
                
                attributes = {
                        texcoord: {	type: 'v2', value: [] },
                    };

                    uniforms = {
                        vcolor:     { type: "c", value: new THREE.Color( 0xff0000 ) }
                    };
                //mesh = new THREE.Mesh( geometry, new THREE.MeshNormalMaterial( { overdraw: true } ) );
            	// create the sphere's material
            	var shaderMaterial = new THREE.ShaderMaterial({
            		vertexShader:   $('#vertexshader').text(),
            		fragmentShader: $('#fragmentshader').text()
            	});
                //var mat = new THREE.MeshBasicMaterial( { color: 0xff0000 } ) 
                
                mesh = new THREE.Mesh( geometry, shaderMaterial);
                scene.add( mesh );
            } );
        }


        });
</script>
</head>
<body>
    <!-- Shaders -->
	<script type="x-shader/x-vertex" id="vertexshader">

		// switch on high precision floats
		#ifdef GL_ES
		precision highp float;
		#endif
        varying vec2 vUv;
		void main()
		{
		    //v_texcoord = texcoord;
		    vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
		}

	</script>
    
	<script type="x-shader/x-fragment" id="fragmentshader">

		#ifdef GL_ES
		precision highp float;
		#endif

        varying vec2 vUv;
		void main()
		{
			gl_FragColor = vec4(1.0-vUv.x,vUv.x,1.0-vUv.x,1.0);
		}

	</script>


    <form id="form">
        rtype:<br>
        <select id="rtype">
          <option value="json">Geometry</option>
          <option value="image">Image</option>
        </select><br>
        py: <br>
        <textarea id="pysource" cols="40" rows="10">
OpenDatabase("noise.silo")
AddPlot("Pseudocolor","hardyglobal")
DrawPlots()</textarea>
        <button>Send</button><br>
    </form>
    <hr>
    <div id="info"></div>
    <div id="image_dest"></div>
    <div id="container"></div>
    </body>


</body>
</html>
